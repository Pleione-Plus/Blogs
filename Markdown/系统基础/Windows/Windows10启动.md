Windows10启动



# 启动过程

​		计算机启动是一个**复杂而有序的**过程，而使用**UEFI**和**BIOS**启动Windows10操作系统又是两种不同的过程。



## BIOS启动

1. 按下**Power键**，此时BIOS进行加电自检(**POST**)，自检通过之后，选择从BIOS中已设置的**第一启动设备**启动（一般为安装Windows 10操作系统的硬盘），然后读取存储于硬盘第一个扇区中的**MBR**并把计算机控制权交于MBR。
2. MBR会搜索存储于自身中的硬盘分区，并找到其中唯一已标注为活动的主分区（**活动分区**），然后在该分区根目录下搜索**bootmgr**（启动管理器）至**内存**并将计算机控制权交于bootmgr。
3. bootmgr搜索位于**活动分区Boot目录**下的**BCD**（启动配置数据），BCD中存储有启动配置选项，如果有多个操作系统启动选项，则bootmgr会显示所有启动选项，并由用户选择。如果只有一个启动选项，bootmgr会默认启动。
4. 默认启动Windows10操作系统之后，bootmgr搜索并读取**Windows分区**Windows\System32目录下的**winload.exe**程序，然后将计算机控制器交给winload.exe，并由其完成内核读取与初始化以及后续启动过程。

![BISO运行流程](../../../MarkdownImgs\系统基础\Windows/Windows10启动/BISO运行流程.png)

## UEFI启动

1. 按下**Power键**，UEFI读取位于**ESP分区**EFI/Micrsoft/Boot/目录下的**bootmgfw.efi文件**并将计算机控制权交于bootmgfw程序。
2. 由bootmgfw搜索并读取存储于EFI/Microsoft/Boot/目录下的**BCD文件**，如果有多个操作系统启动选项，则bootmgfw会显示所有启动选项，并由用户选择。如果只有一个启动选项，bootmgfw会默认启动。
3. 默认启动Windoiws10操作系统之后，bootmgfw搜索并读取Windows分区Windows\System32目录下的**winload.efi**程序，然后将计算机控制器交给winload.efi，并由其完成内核读取与初始化以及后续启动过程。

![UEFI运行流程](../../../MarkdownImgs\系统基础\Windows/Windows10启动/UEFI运行流程.png)

注：

- **活动分区**不一定是Windows分区，默认情况下Windows安装程序会自动创建一个大小为350MB并标注为“活动(active)”的主分区（保留分区）用于Windows10操作系统启动。
- **BCD文**件可以使用bcdedit.exe命令行工具进行修改，也可以使用注册表编辑器挂载进行修改。
- **bootmgr**与**bootmgfw**属于功能相同适用于不同固件的程序。
- BIOS于UEFI启动计算机最大的区别在于，UEFI没有加电自检过程，所以加快了Windows10操作系统的启动速度。

## Windows10安全启动原理

​		安全启动是一项由微软等其他厂商开发的安全标准，用于确保计算机只能被信任的程序启动。Windows10操作系统中的安全启动**基于UEFI固件**来实现其功能。

​		在没有适用UEFI固件的计算机中，操作系统在启动被加载前有漏洞，可通过比较BIOS和UEFI的启动过程可以看得出来。

![Windows10安全启动原理](../../../MarkdownImgs\系统基础\Windows/Windows10启动/Windows10安全启动原理.png)

​		传统的BIOS计算机启动的过程中由于没有保护机制，可以通过将启动加载程序重定向到恶意程序。而加载程序无法通过操作系统安全措施和反恶意软件进行检测。

​		由于UEFI支持固件实施安全策略，所以Windows10操作系统借助UEFI安全启动解决了操作系统启动时任意程序都能被加载的漏洞。

​		计算机在被制造时，厂商将安全启动策略签名数据库存储到NVRAM（非易失性随机访问存储器）中，策略签名数据库主要包括**签名数据库（DB**）、**吊销的签名数据库（DBX）**和**密钥加密密码数据库（KEK）**。

​		当计算机适用安全启动功能启动时，UEFI将按照存储在NVRAM中的策略签名数据库检查每个索要加载的程序，包括UEFI驱动程序以及Windows10操作系统。如果程序有效；UEFI允许程序加载运行，同时将计算机控制权交给操作系统完成启动。如果UEFI驱动程序不受信任，UEFI将启动由设备厂商提供的恢复程序恢复受信任的UEFI。如果操作系统启动程序无效，则UEFI尝试使用备份的启动程序启动，如果还原备份过程失败，UEFI将启动WinRE工具进行修复。



**注**：

- 开启安全启动模式功能必须确保UEFI固件必须是2.3.1以上版本



















